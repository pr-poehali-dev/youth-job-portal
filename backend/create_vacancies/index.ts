export async function handler(req: Request) {
  if (req.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: { 'Content-Type': 'application/json' }
    });
  }

  const API_ENDPOINT = "https://functions.poehali.dev/81ba1a01-47ea-40ac-9ce8-1dc2aa32d523?resource=jobs";
  const timestamp = Date.now();
  
  const vacancies = [
    {
      id: `${timestamp}_1`,
      title: "Продавец-консультант в магазин одежды",
      company: "ТЦ Красноярье",
      location: "ул. Телевизорная, 1, стр. 4, Красноярск",
      type: "Частичная",
      age_range: "16-17",
      salary: "25000 ₽",
      category: "Работа с людьми",
      coordinates: [56.0089, 92.8719],
      is_premium: true,
      description: "Ищем энергичного продавца-консультанта в отдел молодежной одежды. График после школы и в выходные.",
      requirements: ["Коммуникабельность и вежливость", "Опрятный внешний вид", "Желание работать с людьми"],
      responsibilities: ["Консультирование покупателей", "Выкладка товара на витрины", "Поддержание чистоты в торговом зале"],
      conditions: ["Гибкий график работы", "Скидка на товары магазина 20%", "Дружный молодой коллектив", "Обучение за счет компании"],
      contact_phone: "+7 (391) 234-56-78",
      contact_email: "hr@krasnoyarje.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_2`,
      title: "SMM-помощник",
      company: "Digital Studio Сибирь",
      location: "пр. Мира, 32, офис 401, Красноярск",
      type: "Гибкий график",
      age_range: "15-17",
      salary: "20000 ₽",
      category: "IT и технологии",
      coordinates: [56.0184, 92.8672],
      is_premium: false,
      description: "Молодому digital-агентству требуется помощник SMM-менеджера для работы с соцсетями клиентов.",
      requirements: ["Уверенное владение соцсетями", "Грамотная письменная речь", "Креативность и ответственность", "Базовые навыки фотообработки"],
      responsibilities: ["Помощь в создании контента", "Модерация комментариев", "Поиск трендов и идей для постов"],
      conditions: ["Удаленная работа возможна", "Гибкий график", "Обучение от опытных SMM-менеджеров", "Возможность роста внутри компании", "Современный офис в центре"],
      contact_phone: "+7 (391) 567-89-01",
      contact_email: "job@digitalsibir.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_3`,
      title: "Помощник в зоомагазин",
      company: "Четыре Лапы",
      location: "ул. Партизана Железняка, 23, Красноярск",
      type: "Частичная",
      age_range: "14-17",
      salary: "18000 ₽",
      category: "Природа и экология",
      coordinates: [56.0453, 92.8931],
      is_premium: true,
      description: "Ищем ответственного подростка, который любит животных, для работы в зоомагазине.",
      requirements: ["Любовь к животным", "Ответственность и аккуратность", "Готовность учиться"],
      responsibilities: ["Уход за животными в магазине", "Консультация покупателей по уходу за питомцами", "Поддержание чистоты в зоне животных", "Выкладка товаров"],
      conditions: ["График 3-4 дня в неделю", "Скидка на товары для животных", "Дружелюбная атмосфера", "Обучение работе с животными"],
      contact_phone: "+7 (391) 298-45-67",
      contact_email: "work@4lapy-krsk.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_4`,
      title: "Контролер-кассир в кинотеатр",
      company: "Киномакс Красноярск",
      location: "ул. Алексеева, 113, ТРЦ Планета, Красноярск",
      type: "Частичная",
      age_range: "16-17",
      salary: "22000 ₽",
      category: "Работа с людьми",
      coordinates: [56.0321, 92.9103],
      is_premium: false,
      description: "Приглашаем контролера-кассира в кинотеатр. Работа в вечернее время и выходные дни.",
      requirements: ["Приветливость и вежливость", "Готовность работать с кассой", "Пунктуальность"],
      responsibilities: ["Продажа билетов в кино", "Контроль входа в залы", "Помощь посетителям кинотеатра"],
      conditions: ["Бесплатный просмотр фильмов", "Скидка в кафе кинотеатра", "График работы вечером и в выходные", "Официальное трудоустройство", "Дружный коллектив"],
      contact_phone: "+7 (391) 276-54-32",
      contact_email: "hr@kinomax-krsk.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_5`,
      title: "Репетитор по английскому языку",
      company: "Учебный центр Знание",
      location: "ул. Ленина, 145, Красноярск",
      type: "Гибкий график",
      age_range: "16-17",
      salary: "30000 ₽",
      category: "Работа с информацией",
      coordinates: [56.0097, 92.8526],
      is_premium: true,
      description: "Ищем старшеклассника с отличным знанием английского для занятий с детьми 7-10 лет.",
      requirements: ["Высокий уровень английского (B2+)", "Терпеливость и любовь к детям", "Грамотная речь", "Опыт приветствуется, но не обязателен"],
      responsibilities: ["Проведение занятий по английскому", "Помощь с домашними заданиями", "Игровые методики обучения"],
      conditions: ["Свободный график - сам выбираешь время", "Высокая оплата", "Уютный учебный класс", "Методические материалы предоставляются"],
      contact_phone: "+7 (391) 245-78-90",
      contact_email: "info@znanie-krsk.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_6`,
      title: "Тестировщик мобильных игр",
      company: "GameDev Studio KRS",
      location: "ул. Марковского, 55, Красноярск",
      type: "Гибкий график",
      age_range: "14-17",
      salary: "25000 ₽",
      category: "IT и технологии",
      coordinates: [56.0267, 92.8615],
      is_premium: false,
      description: "Игровая студия ищет подростка для тестирования новых мобильных игр и поиска багов.",
      requirements: ["Опыт игры в мобильные игры", "Внимательность к деталям", "Умение описывать найденные проблемы", "Базовые знания ПК"],
      responsibilities: ["Тестирование игровых механик", "Поиск и описание ошибок", "Заполнение отчетов о багах", "Предложение идей по улучшению игры"],
      conditions: ["Удаленная работа", "Гибкий график", "Ранний доступ к новым играм", "Возможность влиять на разработку", "Дружелюбная команда геймеров"],
      contact_phone: "+7 (391) 289-34-56",
      contact_email: "jobs@gamedevkrs.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_7`,
      title: "Помощник на мероприятия",
      company: "Event Agency Праздник",
      location: "ул. Робеспьера, 6, Красноярск",
      type: "Проектная",
      age_range: "15-17",
      salary: "35000 ₽",
      category: "Активная работа",
      coordinates: [56.0156, 92.8940],
      is_premium: true,
      description: "Требуется активный помощник для работы на мероприятиях: свадьбы, корпоративы, детские праздники.",
      requirements: ["Энергичность и активность", "Коммуникабельность", "Ответственность", "Готовность работать в выходные"],
      responsibilities: ["Помощь в организации мероприятий", "Встреча и размещение гостей", "Помощь ведущим и аниматорам", "Раздача материалов участникам"],
      conditions: ["Оплата за каждое мероприятие", "Свободный график", "Участие в интересных событиях", "Опыт в event-индустрии", "Возможность подработки"],
      contact_phone: "+7 (391) 256-78-45",
      contact_email: "work@prazdnik-krsk.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_8`,
      title: "Курьер на велосипеде",
      company: "Доставка Еды 24/7",
      location: "ул. Взлетная, 7, Красноярск",
      type: "Гибкий график",
      age_range: "16-17",
      salary: "40000 ₽",
      category: "Активная работа",
      coordinates: [56.0445, 92.9189],
      is_premium: false,
      description: "Ищем курьеров на велосипеде для доставки еды. Высокие чаевые и свободный график!",
      requirements: ["Наличие велосипеда", "Знание города", "Физическая выносливость", "Ответственность"],
      responsibilities: ["Доставка заказов клиентам", "Проверка комплектности заказов", "Общение с клиентами"],
      conditions: ["Гибкий график - работай когда удобно", "Высокая оплата + чаевые", "Выплаты каждую неделю", "Предоставляем термосумку", "Бонусы за количество заказов"],
      contact_phone: "+7 (391) 290-12-34",
      contact_email: "courier@delivery24-7.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_9`,
      title: "Кассир в кафе быстрого питания",
      company: "Бургер House",
      location: "пр. Красноярский рабочий, 175, Красноярск",
      type: "Частичная",
      age_range: "16-17",
      salary: "23000 ₽",
      category: "Работа с людьми",
      coordinates: [56.0512, 92.9267],
      is_premium: true,
      description: "Сеть кафе быстрого питания приглашает кассира. График после школы и в выходные.",
      requirements: ["Вежливость и улыбчивость", "Готовность работать с кассой", "Стрессоустойчивость"],
      responsibilities: ["Прием и оформление заказов", "Работа с кассой", "Консультация гостей по меню", "Поддержание чистоты рабочего места"],
      conditions: ["Бесплатное питание в смену", "График 3-4 смены в неделю", "Обучение за счет компании", "Дружный коллектив", "Карьерный рост"],
      contact_phone: "+7 (391) 267-89-23",
      contact_email: "job@burgerhouse-krsk.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_10`,
      title: "Помощник садовника",
      company: "Ландшафтная мастерская Зеленый город",
      location: "ул. Семафорная, 433, Красноярск",
      type: "Стажировка",
      age_range: "14-17",
      salary: "20000 ₽",
      category: "Природа и экология",
      coordinates: [55.9987, 92.8134],
      is_premium: false,
      description: "Приглашаем подростка на летнюю стажировку для помощи в уходе за садами и парками.",
      requirements: ["Любовь к природе и растениям", "Готовность к физическому труду", "Ответственность"],
      responsibilities: ["Полив и уход за растениями", "Прополка сорняков", "Помощь в посадке цветов", "Уборка территории"],
      conditions: ["Работа на свежем воздухе", "Обучение основам ландшафтного дизайна", "График 5 дней в неделю", "Дружелюбная команда", "Возможность трудоустройства после стажировки"],
      contact_phone: "+7 (391) 234-67-89",
      contact_email: "info@greentown-krsk.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_11`,
      title: "Дизайнер стикеров для Telegram",
      company: "Creative Lab Крск",
      location: "ул. Копылова, 76, Красноярск",
      type: "Проектная",
      age_range: "15-17",
      salary: "28000 ₽",
      category: "Творчество и дизайн",
      coordinates: [56.0234, 92.8891],
      is_premium: true,
      description: "Творческая студия ищет подростка для создания стикерпаков для Telegram и других мессенджеров.",
      requirements: ["Умение рисовать (цифровое или традиционное)", "Креативность и чувство юмора", "Знание Photoshop или аналогов", "Портфолио приветствуется"],
      responsibilities: ["Создание персонажей для стикеров", "Разработка эмоций и поз", "Доработка по комментариям", "Генерация идей для стикерпаков"],
      conditions: ["Удаленная работа", "Оплата за каждый стикерпак", "Свободный график", "Творческая команда", "Портфолио для будущей карьеры"],
      contact_phone: "+7 (391) 278-90-12",
      contact_email: "design@creativelab-krsk.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_12`,
      title: "Промоутер",
      company: "Промо-Сервис Красноярск",
      location: "ул. 9 Мая, 77, ТЦ Июнь, Красноярск",
      type: "Проектная",
      age_range: "16-17",
      salary: "32000 ₽",
      category: "Работа с людьми",
      coordinates: [56.0389, 92.8745],
      is_premium: false,
      description: "Требуются активные промоутеры для раздачи листовок и промо-акций в торговых центрах.",
      requirements: ["Коммуникабельность", "Энергичность и позитив", "Приятная внешность", "Готовность много общаться"],
      responsibilities: ["Раздача рекламных материалов", "Приглашение людей на акции", "Консультирование о продуктах/услугах", "Фотоотчеты о проделанной работе"],
      conditions: ["Оплата посменно или за акцию", "Гибкий график", "Интересные промо-кампании", "Возможность участия в крупных event", "Быстрые выплаты"],
      contact_phone: "+7 (391) 245-34-78",
      contact_email: "promo@service-krsk.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_13`,
      title: "Помощник фотографа",
      company: "Фотостудия Момент",
      location: "ул. Весны, 7а, Красноярск",
      type: "Частичная",
      age_range: "15-17",
      salary: "24000 ₽",
      category: "Творчество и дизайн",
      coordinates: [56.0145, 92.8567],
      is_premium: true,
      description: "Фотостудия ищет помощника для ассистирования на фотосессиях и работы в студии.",
      requirements: ["Интерес к фотографии", "Аккуратность и внимательность", "Готовность учиться", "Физическая выносливость"],
      responsibilities: ["Подготовка студии к съемкам", "Помощь в работе со светом и оборудованием", "Работа с реквизитом", "Базовая обработка фотографий"],
      conditions: ["Обучение фотомастерству", "График 2-3 раза в неделю", "Скидки на фотосессии для себя", "Возможность создать портфолио", "Творческая атмосфера"],
      contact_phone: "+7 (391) 289-56-34",
      contact_email: "studio@moment-krsk.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_14`,
      title: "Помощник библиотекаря",
      company: "Библиотека им. Горького",
      location: "ул. Горького, 28, Красноярск",
      type: "Частичная",
      age_range: "14-17",
      salary: "17000 ₽",
      category: "Работа с информацией",
      coordinates: [56.0201, 92.8703],
      is_premium: false,
      description: "Городская библиотека приглашает подростка для помощи в работе с книжным фондом.",
      requirements: ["Любовь к чтению и книгам", "Аккуратность и внимательность", "Усидчивость", "Грамотность"],
      responsibilities: ["Расстановка книг по полкам", "Помощь читателям в поиске литературы", "Работа с каталогом", "Подготовка книг к выдаче"],
      conditions: ["Спокойная работа в тишине", "График после школы", "Доступ к новинкам литературы", "Культурная среда", "Возможность читать на работе"],
      contact_phone: "+7 (391) 223-45-67",
      contact_email: "work@library-krsk.ru",
      employer_id: "6"
    },
    {
      id: `${timestamp}_15`,
      title: "Ассистент в ветеринарную клинику",
      company: "Ветклиника Айболит",
      location: "ул. Академика Вавилова, 37, Красноярск",
      type: "Стажировка",
      age_range: "16-17",
      salary: "21000 ₽",
      category: "Природа и экология",
      coordinates: [56.0312, 92.9045],
      is_premium: false,
      description: "Ветеринарная клиника приглашает ответственного подростка на стажировку ассистента ветеринара.",
      requirements: ["Любовь к животным", "Ответственность и аккуратность", "Не бояться грязной работы", "Желание связать жизнь с ветеринарией"],
      responsibilities: ["Помощь ветеринарам на приеме", "Уход за животными в стационаре", "Уборка и дезинфекция помещений", "Общение с владельцами животных"],
      conditions: ["Обучение основам ветеринарии", "График 3 дня в неделю", "Скидка на услуги для своих питомцев", "Возможность трудоустройства после обучения", "Рекомендательное письмо по итогам стажировки"],
      contact_phone: "+7 (391) 267-12-89",
      contact_email: "hr@aibolit-vet.ru",
      employer_id: "6"
    }
  ];

  const results = {
    success: 0,
    failed: 0,
    errors: [] as any[]
  };

  for (const vacancy of vacancies) {
    try {
      const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(vacancy)
      });

      if (response.ok) {
        results.success++;
      } else {
        results.failed++;
        results.errors.push({
          vacancy: vacancy.title,
          status: response.status,
          message: await response.text()
        });
      }
    } catch (error: any) {
      results.failed++;
      results.errors.push({
        vacancy: vacancy.title,
        error: error.message
      });
    }
    
    // Small delay between requests
    await new Promise(resolve => setTimeout(resolve, 300));
  }

  return new Response(JSON.stringify(results, null, 2), {
    status: 200,
    headers: { 'Content-Type': 'application/json' }
  });
}